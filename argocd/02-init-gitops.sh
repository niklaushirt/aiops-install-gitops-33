#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#       __________  __ ___       _____    ________            
#      / ____/ __ \/ // / |     / /   |  /  _/ __ \____  _____
#     / /   / /_/ / // /| | /| / / /| |  / // / / / __ \/ ___/
#    / /___/ ____/__  __/ |/ |/ / ___ |_/ // /_/ / /_/ (__  ) 
#    \____/_/      /_/  |__/|__/_/  |_/___/\____/ .___/____/  
#                                              /_/            
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#---------------------------------------------------------------------------------------------------------------------------------------------------"
#  Installing CP4WAIOPS 3.2
#
#  CloudPak for Watson AIOps
#
#  ¬©2021 nikh@ch.ibm.com
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
clear
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
echo "      __________  __ ___       _____    ________            "
echo "     / ____/ __ \/ // / |     / /   |  /  _/ __ \____  _____"
echo "    / /   / /_/ / // /| | /| / / /| |  / // / / / __ \/ ___/"
echo "   / /___/ ____/__  __/ |/ |/ / ___ |_/ // /_/ / /_/ (__  ) "
echo "   \____/_/      /_/  |__/|__/_/  |_/___/\____/ .___/____/  "
echo "                                             /_/            "
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
echo "  "
echo "  üöÄ CloudPak for Watson AIOps 3.2 - Openshift GitOps Install "
echo "  "
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
echo "  "
echo "  "
echo ""
echo ""
echo ""
echo ""
echo ""




echo "  "
export actBranch=$(git branch | tr -d '* ')
echo "--------------------------------------------------------------------------------------------------------------------------------"
echo "    üöÄ  Update Branch to $actBranch"
echo "--------------------------------------------------------------------------------------------------------------------------------"
cp ./argocd/install/3-argocd-installer.yaml /tmp/3-installer.yaml
gsed -i "s/targetRevision: .*/targetRevision: $actBranch/g" /tmp/3-installer.yaml
gsed -i "s/value: main/value: $actBranch/g" /tmp/3-installer.yaml

cat /tmp/3-installer.yaml

echo "  "
echo "***************************************************************************************************************************************************"
echo "  üì• Create Installer Application in ArgoCD"

oc apply -n openshift-gitops -f /tmp/3-installer.yaml


echo "  "
echo "***************************************************************************************************************************************************"
echo "  üì• Create Installer GitRepository in ArgoCD"
export ARGOCD_URL=$(oc get route -n  openshift-gitops  openshift-gitops-server -o jsonpath={.spec.host})
export ARGOCD_USER=admin
export ARGOCD_PWD=$(oc get secret -n openshift-gitops openshift-gitops-cluster -o "jsonpath={.data['admin\.password']}"| base64 --decode)
echo "    -----------------------------------------------------------------------------------------------------------------------------------------------"
echo "    -----------------------------------------------------------------------------------------------------------------------------------------------"
echo "    üöÄ Connect to OpenShift GitOps to check your deployments"
echo "    -----------------------------------------------------------------------------------------------------------------------------------------------"
echo "    -----------------------------------------------------------------------------------------------------------------------------------------------"
echo "    "
echo "  "

echo "  "
echo "***************************************************************************************************************************************************"
echo "  üîê Login Credentials"
echo "        üåè URL:      https://$ARGOCD_URL"
echo "  "
echo "        üßî User:       $ARGOCD_USER"
echo "        üîê Password:   $ARGOCD_PWD"
echo "  "

argocd login $ARGOCD_URL --insecure --username $ARGOCD_USER --password $ARGOCD_PWD
argocd repo add https://github.com/niklaushirt/aiops-install-gitops-33  --name cp4waiops-repo



exit 1
